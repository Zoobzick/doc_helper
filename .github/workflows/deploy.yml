name: Deploy

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s" "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}

          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.DJANGO_ALLOWED_HOSTS }}

          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}

          DOC_HELPER_BASE_ID_DIR: ${{ secrets.DOC_HELPER_BASE_ID_DIR }}
        run: |
          set -e

          # 1. Собираем env-файл НА RUNNER-е (тут secrets точно есть)
          escape() { printf "%s" "$1" | sed "s/'/'\"'\"'/g"; }
          
          cat > /tmp/doc_helper.env <<EOF
          DJANGO_DEBUG='0'
          DJANGO_SECRET_KEY='$(escape "$DJANGO_SECRET_KEY")'
          DJANGO_ALLOWED_HOSTS='$(escape "$DJANGO_ALLOWED_HOSTS")'
          DOC_HELPER_BASE_ID_DIR='$(escape "$DOC_HELPER_BASE_ID_DIR")'
          DB_NAME='$(escape "$DB_NAME")'
          DB_USER='$(escape "$DB_USER")'
          DB_PASSWORD='$(escape "$DB_PASSWORD")'
          DB_HOST='$(escape "$DB_HOST")'
          DB_PORT='$(escape "$DB_PORT")'
          EOF

          # 2. Копируем env-файл на сервер
          scp -i ~/.ssh/id_ed25519 /tmp/doc_helper.env ${SSH_USER}@${SSH_HOST}:/tmp/doc_helper.env

          # 3. Деплой на сервере
          ssh -i ~/.ssh/id_ed25519 ${SSH_USER}@${SSH_HOST} \
            "PROJECT_DIR='${PROJECT_DIR}' bash -se" <<'REMOTE'
          set -e

          PROJECT_DIR="$(printf "%s" "$PROJECT_DIR" | tr -d '\r\n')"

          echo "== PROJECT_DIR =="
          echo "$PROJECT_DIR"
          ls -la "$PROJECT_DIR" | head -n 5

          # Проверка, что это git-репозиторий
          test -d "$PROJECT_DIR/.git"

          # Код
          sudo -u webapp git -C "$PROJECT_DIR" pull

          # env-файл
          sudo mkdir -p /etc/doc_helper
          sudo tee /etc/doc_helper/doc_helper.env > /dev/null < /tmp/doc_helper.env
          sudo chown root:webapp /etc/doc_helper/doc_helper.env
          sudo chmod 640 /etc/doc_helper/doc_helper.env
          rm -f /tmp/doc_helper.env

          # Зависимости
          sudo -u webapp bash -lc "
            cd '$PROJECT_DIR'
            source venv/bin/activate
            pip install -r requirements.txt
          "
          
          sudo chown -R webapp:webapp "$PROJECT_DIR/staticfiles"

          # Миграции и статика (явно подгружаем env)
          sudo -u webapp bash -lc "
            set -a
            source /etc/doc_helper/doc_helper.env
            set +a
            cd '$PROJECT_DIR'
            source venv/bin/activate
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput
          "

          sudo systemctl restart gunicorn-doc_helper
          sudo systemctl reload nginx
          REMOTE
