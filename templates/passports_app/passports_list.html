{% extends 'base.html' %}
{% load static %}

{% block content %}

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Fast Pass</h1>
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row">
        <div class="col-lg-12">

          <div class="card">
            <div class="card-body">

              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="card-title mb-0">Поиск паспортов</h5>
                  <p class="mb-0">Файлы кроме PDF, находятся в разработке.</p>
                </div>

                {% if user.is_superuser or perms.passports_app.import_passports %}
                <form action="{% url 'import_passports' %}" method="POST" class="ms-3">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-primary">
                      <i class="bi bi-upload me-1"></i> Импорт
                  </button>
                </form>
                {% endif %}
              </div>

              <table id="myTable" class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Материал</th>
                    <th scope="col">Документ</th>
                    <th scope="col">Дата</th>
                    <th scope="col">Расход, %</th>
                    <th scope="col">Файл</th>
                  </tr>
                </thead>

                <tbody>
                  {% for passport in passports %}
                    <tr>
                      <th scope="row">{{ forloop.counter }}</th>

                      <td>{{ passport.material.name }}</td>

                      <td>
                        {{ passport.document_name }}
                        {% if passport.document_number %}
                          №{{ passport.document_number }}
                        {% endif %}
                      </td>

                      <td {% if passport.document_date %}data-order="{{ passport.document_date|date:'Y-m-d' }}"{% endif %}>
                        {% if passport.document_date %}
                          {{ passport.document_date|date:"d.m.Y" }}
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>

                      {# Расход #}
                      {% if user.is_superuser or perms.passports_app.change_passport_consumption %}
                        <td class="consumption-cell" ondblclick="enableEdit(this, {{ passport.id }})">
                          <span class="consumption-value" id="value-{{ passport.id }}">
                            {{ passport.consumption }}
                          </span>

                          <form method="post"
                                action="{% url 'update_consumption' passport.id %}"
                                class="consumption-form d-none"
                                id="form-{{ passport.id }}"
                                onsubmit="return validateConsumption(this)">
                            {% csrf_token %}

                            <div class="input-group input-group-sm">
                              <input type="number"
                                     name="consumption"
                                     value="{{ passport.consumption }}"
                                     min="0"
                                     max="100"
                                     step="0.01"
                                     class="form-control form-control-sm"
                                     style="width: 80px;"
                                     required
                                     onkeypress="if(event.key === 'Enter') { this.form.submit(); return false; }">

                              <button type="submit"
                                      class="btn btn-success btn-sm py-0 px-2"
                                      title="Сохранить (Enter)">
                                <i class="bi bi-check"></i>
                              </button>

                              <button type="button"
                                      class="btn btn-secondary btn-sm py-0 px-2"
                                      onclick="cancelEdit({{ passport.id }})"
                                      title="Отмена (Esc)">
                                <i class="bi bi-x"></i>
                              </button>
                            </div>
                          </form>
                        </td>
                      {% else %}
                        <td class="text-muted">{{ passport.consumption }}</td>
                      {% endif %}

                      <td>
                        {% if passport.file_name|lower|slice:"-4:" == ".pdf" %}
                          {% if user.is_superuser or perms.passports_app.open_passport_file %}
                            <a href="{% url 'view_pdf' passport.id %}"
                               target="_blank"
                               class="btn btn-sm btn-outline-danger"
                               title="Открыть PDF в браузере">
                              <i class="bi bi-file-earmark-pdf-fill"></i> PDF
                            </a>
                          {% else %}
                            <span class="text-muted">Нет прав</span>
                          {% endif %}
                        {% else %}
                          <a href="{{ passport.file_path|safe }}"
                             class="btn btn-sm btn-outline-secondary text-decoration-none"
                             title="Путь к файлу: {{ passport.file_path }} (ПКМ → Копировать ссылку)">
                            <i class="bi bi-file-earmark"></i> {{ passport.file_name|slice:"-4:"|upper }}
                          </a>
                        {% endif %}
                      </td>

                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="6" class="text-center text-muted">
                        Нет данных. Загрузите паспорта через меню "Обновить паспорта".
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

            </div>
          </div>

        </div>
      </div>
    </section>

  </main><!-- End #main -->

{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
  $('#myTable').DataTable({
    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json' },
    order: [[3, 'desc']],
    search: { smart: false },
    stateSave: true,
    stateDuration: -1,
    columnDefs: [
      {
        targets: [3, 4],
        className: 'dt-head-nowrap text-center'
      }
    ]
  });
});
</script>

<script>
// Включить редактирование
function enableEdit(cell, passportId) {
  // Если формы нет (права нет) — просто выходим
  const form = document.getElementById(`form-${passportId}`);
  const valueSpan = document.getElementById(`value-${passportId}`);
  if (!form || !valueSpan) return;

  valueSpan.classList.add('d-none');
  form.classList.remove('d-none');

  const input = form.querySelector('input[name="consumption"]');
  if (input) {
    input.focus();
    input.select();
  }
}

// Отменить редактирование
function cancelEdit(passportId) {
  const form = document.getElementById(`form-${passportId}`);
  const valueSpan = document.getElementById(`value-${passportId}`);
  if (!form || !valueSpan) return;

  valueSpan.classList.remove('d-none');
  form.classList.add('d-none');
}

// Валидация
function validateConsumption(form) {
  const input = form.querySelector('input[name="consumption"]');
  const value = parseFloat(input.value);

  if (isNaN(value)) {
    alert('Введите число');
    input.focus();
    return false;
  }

  if (value < 0 || value > 100) {
    alert('Значение должно быть от 0 до 100');
    input.focus();
    return false;
  }

  return true;
}

// Esc закрывает форму
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    document.querySelectorAll('.consumption-form:not(.d-none)').forEach(form => {
      const passportId = form.id.replace('form-', '');
      cancelEdit(passportId);
    });
  }
});
</script>
{% endblock extra_js %}
