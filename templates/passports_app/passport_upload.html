{% extends "base.html" %}
{% load static %}

{% block content %}

    <div class="pagetitle">
        <h1>Добавить паспорта</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'passports:passports_list' %}">Паспорта</a></li>
                <li class="breadcrumb-item active">Добавление</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="card">
            <div class="card-body">

                <!-- Tabs как в projects_create -->
                <ul class="nav nav-tabs nav-tabs-bordered mt-3" id="createTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-onefile" data-bs-toggle="tab"
                                data-bs-target="#pane-onefile"
                                type="button" role="tab" aria-controls="pane-onefile" aria-selected="true">
                            Один файл
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-zip" data-bs-toggle="tab" data-bs-target="#pane-zip"
                                type="button" role="tab" aria-controls="pane-zip" aria-selected="false">
                            ZIP архив
                        </button>
                    </li>
                </ul>

                <div class="tab-content pt-3" id="createTabsContent">

                    <!-- ========================================================= -->
                    <!-- TAB: ONE FILE -->
                    <!-- ========================================================= -->
                    <div class="tab-pane fade show active" id="pane-onefile" role="tabpanel"
                         aria-labelledby="tab-onefile">

                        <div class="row">
                            <!-- Левая колонка -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">

                                        <h5 class="card-title">Загрузите файл паспорта</h5>

                                        <!-- ✅ DnD зона: 1-в-1 как в project_create (классы + style + структура текста) -->
                                        <div id="passportDropZone"
                                             class="border border-2 border-secondary rounded-3 p-5 text-center"
                                             style="border-style:dashed; user-select:none; cursor:pointer;">
                                            <div class="fw-semibold">Перетащите сюда файл</div>
                                            <div class="text-muted small">или кликните, чтобы выбрать</div>
                                        </div>

                                        <div id="uploadStatus" class="mt-3"></div>

                                        {% if form.file.errors %}
                                            <div class="text-danger small mt-2">{{ form.file.errors }}</div>
                                        {% endif %}

                                        <div class="form-text mt-2" id="hintSingle">
                                            Поддерживаемые форматы: <code>pdf</code>, <code>psd</code>,
                                            <code>xlsx</code>, <code>docx</code>.<br>
                                            Имя файла желательно:
                                            <code>материал (наименование_документа №номер_документа от
                                                дд.мм.гггг).ext</code>
                                        </div>

                                        <hr class="my-4">

                                        <!-- ОДНА форма на обе вкладки, URL тот же -->
                                        <form method="post" enctype="multipart/form-data" id="passportForm">
                                            {% csrf_token %}

                                            <div class="d-none">
                                                {{ form.file }}
                                            </div>

                                            {{ form.action }}

                                            <!-- DATALIST ДЛЯ МАТЕРИАЛОВ -->
                                            <datalist id="materialsList">
                                                {% for name in materials %}
                                                    <option value="{{ name }}"></option>
                                                {% endfor %}
                                            </datalist>

                                            <!-- Блок полей (только для одиночного файла) -->
                                            <div id="metaBlock" class="d-none">
                                                <h5 class="card-title mb-2">2) Данные паспорта</h5>

                                                <div class="row g-3">

                                                    <div class="col-12">
                                                        <label class="form-label">{{ form.material.label }}</label>
                                                        <input type="text" name="material" class="form-control"
                                                               placeholder="Напр.: Труба 45х3"
                                                               list="materialsList"
                                                               value="{{ form.material.value|default_if_none:'' }}">
                                                    </div>

                                                    <div class="col-12">
                                                        <label class="form-label">{{ form.document_name.label }}</label>
                                                        {{ form.document_name }}
                                                    </div>

                                                    <div class="col-12">
                                                        <label class="form-label">{{ form.document_number.label }}</label>
                                                        {{ form.document_number }}
                                                    </div>

                                                    <div class="col-12">
                                                        <label class="form-label">{{ form.document_date.label }}</label>
                                                        {{ form.document_date }}
                                                    </div>

                                                </div>
                                            </div>

                                            <div class="mt-3 d-flex gap-2 flex-wrap">
                                                <button class="btn btn-success" type="submit" id="btnSave" disabled>
                                                    <i class="bi bi-check2-circle me-1"></i> Сохранить
                                                </button>

                                                <button class="btn btn-outline-success" type="submit"
                                                        id="btnSaveAddMore" disabled>
                                                    <i class="bi bi-plus-circle me-1"></i> Сохранить и добавить ещё
                                                </button>

                                                <a class="btn btn-outline-secondary"
                                                   href="{% url 'passports:passports_list' %}">Назад</a>

                                                <button class="btn btn-outline-secondary" type="button" id="btnReset"
                                                        disabled>Сбросить
                                                </button>
                                            </div>

                                            <div class="mt-2 text-muted small" id="pickedInfo"></div>
                                        </form>

                                    </div>
                                </div>
                            </div>

                            <!-- Правая колонка -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Предпросмотр</h5>

                                        <div id="previewEmpty" class="text-muted">
                                            Выберите файл — здесь появится предпросмотр (PDF).
                                        </div>

                                        <div id="previewNonPdf" class="d-none">
                                            <div class="alert alert-info py-2 mb-0">
                                                Предпросмотр доступен только для файлов формата PDF.
                                            </div>
                                        </div>

                                        <iframe id="pdfPreviewFrame"
                                                style="display:none; width:100%; height:70vh; border:1px solid #e5e5e5; border-radius:8px;"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- ========================================================= -->
                    <!-- TAB: ZIP -->
                    <!-- ========================================================= -->
                    <div class="tab-pane fade" id="pane-zip" role="tabpanel" aria-labelledby="tab-zip">

                        <div class="row">
                            <!-- Левая колонка -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">

                                        <h5 class="card-title">Загрузить ZIP архив</h5>

                                        <!-- ✅ DnD зона: 1-в-1 как в project_create -->
                                        <div id="zipDropZone"
                                             class="border border-2 border-secondary rounded-3 p-5 text-center"
                                             style="border-style:dashed; user-select:none; cursor:pointer;">
                                            <div class="fw-semibold">Перетащите сюда ZIP</div>
                                            <div class="text-muted small">или кликните, чтобы выбрать</div>
                                        </div>

                                        <div class="form-text mt-2" id="hintZip">
                                            Загрузите <code>.zip</code>. Внутри могут быть папки/подпапки. Будут
                                            импортированы файлы:
                                            <code>pdf</code>, <code>psd</code>, <code>xlsx</code>, <code>docx</code>.
                                        </div>

                                        <div id="zipUploadStatus" class="mt-3"></div>
                                        <!-- ZIP upload progress -->
                                        <div id="zipProgressWrap" class="mt-3 d-none">
                                            <div class="d-flex justify-content-between small text-muted mb-1">
                                                <span>Загрузка архива…</span>
                                                <span id="zipProgressPct">0%</span>
                                            </div>
                                            <div class="progress">
                                                <div id="zipProgressBar"
                                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                                     style="width:0%"></div>
                                            </div>
                                        </div>


                                        <div class="mt-3 d-flex gap-2 flex-wrap">
                                            <!-- Используем ту же форму и кнопку "Сохранить" (submit). -->
                                            <button class="btn btn-success" type="submit" form="passportForm"
                                                    id="btnZipImport" disabled>
                                                <i class="bi bi-upload me-1"></i> Импортировать архив
                                            </button>

                                            <button class="btn btn-outline-secondary" type="button" id="zipBtnReset"
                                                    disabled>
                                                Сбросить
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Правая колонка -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Результат импорта</h5>

                                        {% if zip_stats %}
                                            <div class="row g-2 mb-3">
                                                <div class="col-12 col-lg-3">
                                                    <div class="alert alert-secondary mb-0">Всего:
                                                        <strong>{{ zip_stats.total }}</strong></div>
                                                </div>
                                                <div class="col-12 col-lg-3">
                                                    <div class="alert alert-success mb-0">Успешно:
                                                        <strong>{{ zip_stats.imported }}</strong></div>
                                                </div>
                                                <div class="col-12 col-lg-3">
                                                    <div class="alert alert-warning mb-0">На проверку:
                                                        <strong>{{ zip_stats.needs_review }}</strong></div>
                                                </div>
                                                <div class="col-12 col-lg-3">
                                                    <div class="alert alert-danger mb-0">Ошибок:
                                                        <strong>{{ zip_stats.errors }}</strong></div>
                                                </div>
                                            </div>

                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered align-middle">
                                                    <thead>
                                                    <tr>
                                                        <th>Файл в архиве</th>
                                                        <th>Статус</th>
                                                        <th>Сообщение</th>
                                                        <th class="text-center">Паспорт</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for r in zip_results %}
                                                        <tr
                                                                {% if r.status == "imported" %}class="table-success"{% endif %}
                                                                {% if r.status == "needs_review" %}class="table-warning"{% endif %}
                                                                {% if r.status == "error" %}class="table-danger"{% endif %}
                                                        >
                                                            <td style="word-break: break-word;">{{ r.rel_path }}</td>
                                                            <td class="text-nowrap">{{ r.status }}</td>
                                                            <td style="word-break: break-word;">{{ r.message }}</td>
                                                            <td class="text-center text-nowrap">
                                                                {% if r.passport_id %}
                                                                    <a class="btn btn-sm btn-outline-primary"
                                                                       href="{% url 'passports:passport_detail' r.passport_id %}">
                                                                        <i class="bi bi-box-arrow-up-right"></i>
                                                                    </a>
                                                                {% else %}
                                                                    —
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="text-muted">
                                                Здесь появится отчёт после обработки архива.
                                            </div>
                                        {% endif %}

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

            </div>
        </div>
    </section>

{% endblock %}

{% block extra_js %}
<script>
  (function () {
    function bindDnD(dropEl) {
      ["dragenter", "dragover", "dragleave", "drop"].forEach((evt) => {
        dropEl.addEventListener(
          evt,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        );
      });
      dropEl.addEventListener("dragover", () => dropEl.classList.add("bg-light"));
      dropEl.addEventListener("dragleave", () => dropEl.classList.remove("bg-light"));
      dropEl.addEventListener("drop", () => dropEl.classList.remove("bg-light"));
    }

    function extOf(name) {
      const m = (name || "").toLowerCase().match(/\.([a-z0-9]+)$/);
      return m ? m[1] : "";
    }

    function isPdf(file) {
      const name = file && file.name ? file.name.toLowerCase() : "";
      return (file && file.type === "application/pdf") || name.endsWith(".pdf");
    }

    function setPickedInfo(text) {
      pickedInfo.innerHTML = text || "";
    }

    function setStatus(html) {
      uploadStatus.innerHTML = html || "";
    }

    function setZipStatus(html) {
      zipUploadStatus.innerHTML = html || "";
    }

    function parseFilename(filename) {
      const base = filename.replace(/\.[^/.]+$/, "");
      const re = /^\s*(.+?)\s*\(\s*(.+?)\s*№\s*(.+?)\s+от\s+(\d{2}\.\d{2}\.\d{4})\s*\)\s*$/i;
      const m = base.match(re);
      if (!m) return null;

      const material = m[1].trim().replace(/\s+/g, " ");
      const docName = m[2].trim().replace(/\s+/g, " ");
      const docNumber = m[3].trim().replace(/\s+/g, " ");
      const dmy = m[4];
      const parts = dmy.split(".");
      const iso = `${parts[2]}-${parts[1]}-${parts[0]}`;
      return { material, docName, docNumber, iso };
    }

    // tabs
    const tabOne = document.getElementById("tab-onefile");
    const tabZip = document.getElementById("tab-zip");

    // zones + form
    const dropZone = document.getElementById("passportDropZone");
    const zipDropZone = document.getElementById("zipDropZone");

    const form = document.getElementById("passportForm");
    const fileInput = form.querySelector('input[type="file"]');

    const uploadStatus = document.getElementById("uploadStatus");
    const zipUploadStatus = document.getElementById("zipUploadStatus");

    const metaBlock = document.getElementById("metaBlock");
    const btnSave = document.getElementById("btnSave");
    const btnSaveAddMore = document.getElementById("btnSaveAddMore");
    const btnReset = document.getElementById("btnReset");
    const btnZipImport = document.getElementById("btnZipImport");
    const zipBtnReset = document.getElementById("zipBtnReset");
    const pickedInfo = document.getElementById("pickedInfo");

    const actionInput = form.querySelector('input[name="action"]');

    const materialInput = form.querySelector('input[name="material"]');
    const docNameInput = form.querySelector('input[name="document_name"]');
    const docNumberInput = form.querySelector('input[name="document_number"]');
    const docDateInput = form.querySelector('input[name="document_date"]');

    // preview
    const frame = document.getElementById("pdfPreviewFrame");
    const empty = document.getElementById("previewEmpty");
    const nonPdfBox = document.getElementById("previewNonPdf");
    let currentObjectUrl = null;

    function isZipTabActive() {
      return tabZip.classList.contains("active");
    }

    function clearPreview() {
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = null;
      }
      frame.style.display = "none";
      frame.src = "";
      nonPdfBox.classList.add("d-none");
      empty.style.display = "block";
    }

    function resetAll() {
      clearPreview();

      fileInput.value = "";
      setPickedInfo("");
      setStatus("");
      setZipStatus("");

      // сброс прогресса (если блок есть)
      if (zipProgressWrap) {
        zipProgressWrap.classList.add("d-none");
        setZipProgress(0, 0);
      }

      metaBlock.classList.add("d-none");

      btnSave.disabled = true;
      btnSaveAddMore.disabled = true;
      btnReset.disabled = true;

      btnZipImport.disabled = true;
      zipBtnReset.disabled = true;

      if (materialInput) materialInput.value = "";
      if (docNameInput) docNameInput.value = "";
      if (docNumberInput) docNumberInput.value = "";
      if (docDateInput) docDateInput.value = "";

      // accept зависит от активной вкладки
      if (isZipTabActive()) {
        fileInput.setAttribute("accept", ".zip,application/zip");
      } else {
        fileInput.setAttribute("accept", ".pdf,.psd,.xlsx,.docx,application/pdf");
      }
    }

    function showPdfPreview(file) {
      clearPreview();
      if (!file) return;

      if (isPdf(file)) {
        currentObjectUrl = URL.createObjectURL(file);
        frame.src = currentObjectUrl + "#page=1";
        empty.style.display = "none";
        frame.style.display = "block";
      } else {
        empty.style.display = "none";
        nonPdfBox.classList.remove("d-none");
      }
    }

    function handlePickedFile(file) {
      if (!file) return;

      const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
      setPickedInfo(`Выбран файл: <strong>${file.name}</strong> (${sizeMb} MB)`);

      const e = extOf(file.name);
      const zip = e === "zip";

      if (isZipTabActive()) {
        // ZIP tab: разрешаем только zip
        metaBlock.classList.add("d-none");
        clearPreview();
        empty.style.display = "none";
        nonPdfBox.classList.remove("d-none");

        btnZipImport.disabled = !zip;
        zipBtnReset.disabled = false;

        // отключаем одиночные кнопки
        btnSave.disabled = true;
        btnSaveAddMore.disabled = true;
        btnReset.disabled = true;

        if (!zip) {
          setZipStatus(`<div class="alert alert-danger py-2">Нужен ZIP архив (.zip)</div>`);
        } else {
          setZipStatus(`<div class="alert alert-info py-2 mb-0">Архив выбран. Нажмите “Импортировать архив”.</div>`);
        }
        return;
      }

      // ONE FILE tab: запрещаем zip
      if (zip) {
        setStatus(`<div class="alert alert-danger py-2">На этой вкладке нужен один файл паспорта (не ZIP).</div>`);
        btnSave.disabled = true;
        btnSaveAddMore.disabled = true;
        btnReset.disabled = false;
        metaBlock.classList.add("d-none");
        clearPreview();
        return;
      }

      // показываем поля + preview
      setStatus("");
      metaBlock.classList.remove("d-none");
      btnSave.disabled = false;
      btnSaveAddMore.disabled = false;
      btnReset.disabled = false;

      showPdfPreview(file);

      const parsed = parseFilename(file.name);
      if (parsed) {
        if (!materialInput.value) materialInput.value = parsed.material;
        if (!docNameInput.value) docNameInput.value = parsed.docName;
        if (!docNumberInput.value) docNumberInput.value = parsed.docNumber;
        if (!docDateInput.value) docNumberInput.value = parsed.docNumber;
        if (!docDateInput.value) docDateInput.value = parsed.iso;
      }
    }

    function pickFileFromDnd(file) {
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      handlePickedFile(file);
    }

    // bind zones
    bindDnD(dropZone);
    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) pickFileFromDnd(f);
    });

    bindDnD(zipDropZone);
    zipDropZone.addEventListener("click", () => fileInput.click());
    zipDropZone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) pickFileFromDnd(f);
    });

    fileInput.addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      handlePickedFile(f);
    });

    // buttons
    btnReset.addEventListener("click", resetAll);
    zipBtnReset.addEventListener("click", resetAll);

    btnSave.addEventListener("click", () => {
      actionInput.value = "save";
    });
    btnSaveAddMore.addEventListener("click", () => {
      actionInput.value = "save_add_more";
    });

    // when tab changed — reset and update accept
    tabOne.addEventListener("shown.bs.tab", resetAll);
    tabZip.addEventListener("shown.bs.tab", resetAll);

    /* ================= ZIP UPLOAD WITH PROGRESS + STATUS ================= */

    const zipProgressWrap = document.getElementById("zipProgressWrap");
    const zipProgressBar = document.getElementById("zipProgressBar");
    const zipProgressPct = document.getElementById("zipProgressPct");

    function setZipProgress(loaded, total) {
      const pct = total ? Math.round((loaded / total) * 100) : 0;
      if (zipProgressBar) zipProgressBar.style.width = pct + "%";
      if (zipProgressPct) zipProgressPct.textContent = pct + "%";
    }

    btnZipImport.addEventListener("click", function (e) {
      if (!isZipTabActive()) return;

      e.preventDefault();

      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      // UI
      btnZipImport.disabled = true;
      zipBtnReset.disabled = true;

      if (zipProgressWrap) zipProgressWrap.classList.remove("d-none");
      setZipProgress(0, file.size);

      setZipStatus('<div class="alert alert-secondary py-2 mb-0">Загрузка архива…</div>');

      const xhr = new XMLHttpRequest();
      const postUrl = form.getAttribute("action") || window.location.pathname; // важно: не form.action (может быть input[name=action])
      xhr.open("POST", postUrl, true);
      xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

      xhr.upload.onprogress = function (evt) {
        if (evt.lengthComputable) {
          setZipProgress(evt.loaded, evt.total);

          // когда дошли до 100% — файл уже на сервере, дальше будет распаковка/обработка
          if (evt.loaded >= evt.total) {
            setZipStatus('<div class="alert alert-info py-2 mb-0">Файл загружен. Идёт обработка архива…</div>');
          }
        }
      };

      xhr.onload = function () {
        if (xhr.status >= 200 && xhr.status < 300) {
          setZipStatus('<div class="alert alert-success py-2 mb-0">Обработка завершена. Обновляю страницу…</div>');

          // backend возвращает HTML — перерисовываем страницу
          document.open();
          document.write(xhr.responseText);
          document.close();
          return;
        }

        setZipStatus('<div class="alert alert-danger py-2 mb-0">Ошибка загрузки архива</div>');
        btnZipImport.disabled = false;
        zipBtnReset.disabled = false;
      };

      xhr.onerror = function () {
        setZipStatus('<div class="alert alert-danger py-2 mb-0">Ошибка сети</div>');
        btnZipImport.disabled = false;
        zipBtnReset.disabled = false;
      };

      const fd = new FormData(form);
      xhr.send(fd);
    });

    // init
    resetAll();
  })();
</script>

{% endblock %}
