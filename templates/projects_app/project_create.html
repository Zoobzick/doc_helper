{% extends "base.html" %}
{% load static %}

{% block content %}
    {% block breadcrumbs %}
        <div class="pagetitle">
            <h1>Добавить проекты</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'projects:projects_list' %}">Проекты</a>
                    </li>
                    <li class="breadcrumb-item active">Добавить</li>
                </ol>
            </nav>
        </div>
    {% endblock breadcrumbs %}


    <section class="section">
        <div class="card">
            <div class="card-body">

                <ul class="nav nav-tabs nav-tabs-bordered mt-3" id="createTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-onepdf" data-bs-toggle="tab"
                                data-bs-target="#pane-onepdf"
                                type="button" role="tab" aria-controls="pane-onepdf" aria-selected="true">
                            Один PDF
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-zip" data-bs-toggle="tab" data-bs-target="#pane-zip"
                                type="button" role="tab" aria-controls="pane-zip" aria-selected="false">
                            ZIP архив
                        </button>
                    </li>
                </ul>

                <div class="tab-content pt-3" id="createTabsContent">

                    <!-- ========================================================= -->
                    <!-- TAB: ONE PDF -->
                    <!-- ========================================================= -->
                    <div class="tab-pane fade show active" id="pane-onepdf" role="tabpanel"
                         aria-labelledby="tab-onepdf">

                        <div class="row">
                            <!-- Левая колонка: загрузка + форма -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Загрузите PDF проекта</h5>

                                        <div id="pdfDropZone"
                                             class="border border-2 border-secondary rounded-3 p-5 text-center"
                                             style="border-style:dashed; user-select:none; cursor:pointer;">
                                            <div class="fw-semibold">Перетащите сюда PDF</div>
                                            <div class="text-muted small">или кликните, чтобы выбрать файл</div>
                                            <input id="pdfInput" type="file" accept="application/pdf"
                                                   class="d-none">
                                        </div>

                                        <div id="pdfUploadStatus" class="mt-3"></div>

                                        <hr class="my-4">

                                        <div id="pdfFormBlock"
                                             class="{% if form.errors %}{% else %}d-none{% endif %}">
                                            <h5 class="card-title">2) Заполните данные</h5>

                                            <form method="post" action="{% url 'projects:project_create_save' %}"
                                                  class="row g-3" id="projectForm">
                                                {% csrf_token %}

                                                {{ form.upload_id }}

                                                <div class="col-12">
                                                    <label class="form-label">Полный шифр проекта</label>
                                                    {{ form.full_code }}
                                                    {% if form.full_code.errors %}
                                                        <div class="text-danger small">{{ form.full_code.errors }}</div>{% endif %}
                                                    <div class="form-text">
                                                        Если такой шифр уже есть — PDF будет добавлен как новая
                                                        ревизия.
                                                    </div>
                                                </div>

                                                <div class="col-12">
                                                    <label class="form-label">Наименование / конструкция</label>
                                                    {{ form.construction }}
                                                    {% if form.construction.errors %}
                                                        <div class="text-danger small">{{ form.construction.errors }}</div>{% endif %}
                                                </div>

                                                <div class="col-12">
                                                    <button class="btn btn-success" type="submit">Сохранить</button>
                                                </div>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Правая колонка: preview -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Предпросмотр PDF (1-я страница)</h5>

                                        <div id="pdfPreviewEmpty" class="text-muted">
                                            Выберите один PDF — здесь появится предпросмотр.
                                        </div>

                                        <iframe id="pdfPreviewFrame"
                                                style="display:none; width:100%; height:70vh; border:1px solid #e5e5e5; border-radius:8px;"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- ========================================================= -->
                    <!-- TAB: ZIP ARCHIVE -->
                    <!-- ========================================================= -->
                    <div class="tab-pane fade" id="pane-zip" role="tabpanel" aria-labelledby="tab-zip">

                        <div class="row">
                            <!-- Левая: загрузка архива -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Загрузить ZIP архив</h5>

                                        <div id="zipDropZone"
                                             class="border border-2 border-secondary rounded-3 p-5 text-center"
                                             style="border-style:dashed; user-select:none; cursor:pointer;">
                                            <div class="fw-semibold">Перетащите сюда ZIP</div>
                                            <div class="text-muted small">или кликните, чтобы выбрать файл</div>
                                            <input id="zipInput" type="file" accept=".zip,application/zip"
                                                   class="d-none">
                                        </div>

                                        <div class="mt-3">
                                            <div class="small text-muted">
                                                Что произойдёт:
                                                <ul class="mb-0">
                                                    <li>Архив распакуется на сервере (PDF могут быть в папках)</li>
                                                    <li>Файлы с тем же sha256 будут пропущены</li>
                                                    <li>Остальные попадут в БД</li>
                                                    <li>full_code временно берём из имени PDF</li>
                                                    <li>Если такой full_code уже есть — будет новая ревизия</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div id="zipUploadStatus" class="mt-3"></div>

                                        <!-- ✅ ZIP upload progress (как в passport_upload) -->
                                        <div id="zipProgressWrap" class="mt-3 d-none">
                                            <div class="d-flex justify-content-between small text-muted mb-1">
                                                <span>Загрузка архива…</span>
                                                <span id="zipProgressPct">0%</span>
                                            </div>
                                            <div class="progress">
                                                <div id="zipProgressBar"
                                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                                     style="width:0%"></div>
                                            </div>
                                        </div>

                                        <div class="mt-3 d-flex gap-2">
                                            <button id="zipBtnUpload" class="btn btn-success" disabled>
                                                <i class="bi bi-upload me-1"></i> Загрузить архив
                                            </button>
                                            <button id="zipBtnReset" class="btn btn-outline-secondary" disabled>
                                                Сбросить
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Правая: результат -->
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Результат импорта</h5>

                                        <div id="zipResultSummary" class="text-muted">
                                            Здесь появится отчёт после обработки архива.
                                        </div>

                                        <div id="zipResultTableWrap" class="table-responsive mt-3 d-none">
                                            <table class="table table-bordered table-striped align-middle">
                                                <thead>
                                                <tr>
                                                    <th>Файл</th>
                                                    <th>Проект (full_code)</th>
                                                    <th class="text-center">Ревизия</th>
                                                    <th class="text-center">Статус</th>
                                                </tr>
                                                </thead>
                                                <tbody id="zipResultTbody"></tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>

                </div>

            </div>
        </div>

    </section>
{% endblock %}


{% block extra_js %}
    <script>
        (function () {
            // =========================================================
            // helpers
            // =========================================================
            function getCookie(name) { // (name) имя cookie
                const value = `; ${document.cookie}`; // (value) вся строка cookie
                const parts = value.split(`; ${name}=`); // (parts) разбиение по ключу
                if (parts.length === 2) return parts.pop().split(';').shift(); // (return) значение
                return '';
            }

            const csrftoken = getCookie('csrftoken'); // (csrftoken) CSRF-токен для POST

            function bindDnD(dropEl) { // (dropEl) DOM-элемент dropzone
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                    dropEl.addEventListener(evt, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });
                dropEl.addEventListener('dragover', () => dropEl.classList.add('bg-light'));
                dropEl.addEventListener('dragleave', () => dropEl.classList.remove('bg-light'));
                dropEl.addEventListener('drop', () => dropEl.classList.remove('bg-light'));
            }

            async function safeJson(resp) { // (resp) Response
                const ct = (resp.headers.get("content-type") || ""); // (ct) content-type
                if (!ct.includes("application/json")) {
                    return {ok: false, error: `Сервер вернул не JSON (status ${resp.status})`};
                }
                try {
                    return await resp.json();
                } catch {
                    return {ok: false, error: `Не удалось разобрать JSON (status ${resp.status})`};
                }
            }

            function safeJsonText(text) { // (text) строка ответа xhr.responseText
                try {
                    const obj = JSON.parse(text);
                    return {ok: true, data: obj};
                } catch {
                    return {ok: false, error: "Сервер вернул невалидный JSON"};
                }
            }

            // =========================================================
            // TAB: ONE PDF
            // =========================================================
            const pdfUploadUrl = "{% url 'projects:project_upload_temp' %}"; // (pdfUploadUrl) endpoint временной загрузки PDF

            const pdfDropZone = document.getElementById('pdfDropZone'); // (pdfDropZone) зона DnD PDF
            const pdfInput = document.getElementById('pdfInput'); // (pdfInput) input файла PDF
            const pdfUploadStatus = document.getElementById('pdfUploadStatus'); // (pdfUploadStatus) блок статуса PDF
            const pdfFormBlock = document.getElementById('pdfFormBlock'); // (pdfFormBlock) блок формы после загрузки

            const frame = document.getElementById("pdfPreviewFrame"); // (frame) iframe превью
            const empty = document.getElementById("pdfPreviewEmpty"); // (empty) заглушка превью
            let currentObjectUrl = null; // (currentObjectUrl) blob-url текущего файла

            function pdfSetStatus(html) { // (html) html статуса
                pdfUploadStatus.innerHTML = html || '';
            }

            function showPdfPreview(file) { // (file) выбранный File
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
                if (!file) {
                    frame.style.display = "none";
                    empty.style.display = "block";
                    empty.textContent = "Выберите один PDF — здесь появится предпросмотр.";
                    return;
                }
                const isPdf = (file.type === "application/pdf") || (file.name || "").toLowerCase().endsWith(".pdf"); // (isPdf) проверка pdf
                if (!isPdf) {
                    frame.style.display = "none";
                    empty.style.display = "block";
                    empty.textContent = "Выберите PDF файл.";
                    return;
                }
                currentObjectUrl = URL.createObjectURL(file);
                frame.src = currentObjectUrl + "#page=1";
                empty.style.display = "none";
                frame.style.display = "block";
            }

            async function handlePdfFile(file) { // (file) выбранный PDF
                if (!file) return;
                showPdfPreview(file);

                const isPdf = (file.type === "application/pdf") || (file.name || "").toLowerCase().endsWith(".pdf");
                if (!isPdf) {
                    pdfSetStatus('<div class="alert alert-danger py-2">Разрешены только PDF</div>');
                    pdfFormBlock.classList.add('d-none');
                    return;
                }

                pdfSetStatus('<div class="text-muted">Загрузка…</div>');
                pdfFormBlock.classList.add('d-none');

                const fd = new FormData(); // (fd) multipart-данные
                fd.append('file', file); // ('file') поле для backend

                const resp = await fetch(pdfUploadUrl, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken},
                    body: fd
                });

                const data = await safeJson(resp); // (data) JSON-ответ

                // ✅ сообщение при дубле sha256 (409)
                if (resp.status === 409 || (data && data.status === "duplicate")) {
                    const sha = (data && data.sha256) ? data.sha256 : '';
                    const proj = (data && data.existing_project) ? data.existing_project : '';
                    const rev = (data && data.existing_revision) ? data.existing_revision : '';

                    const uploadIdInput = document.getElementById('id_upload_id'); // (uploadIdInput) скрытое поле upload_id
                    if (uploadIdInput) uploadIdInput.value = "";

                    pdfInput.value = "";

                    pdfSetStatus(`
        <div class="alert alert-warning py-2">
          <div class="fw-semibold">Этот PDF уже есть в системе</div>
          <div class="small text-muted">
            Файл совпал по SHA256, поэтому мы не создаём новую ревизию и не добавляем его повторно.
            ${proj ? `<br>Проект: <strong>${proj}</strong>${rev ? `, ревизия <strong>${rev}</strong>` : ""}` : ""}
            ${sha ? `<br>SHA256: <code>${sha}</code>` : ""}
          </div>
          <div class="small mt-2">Можете сразу перетащить другой PDF.</div>
        </div>
      `);
                    return;
                }

                if (!data || data.ok !== true) {
                    pdfSetStatus(`<div class="alert alert-danger py-2">${(data && (data.error || data.message)) || 'Ошибка загрузки'}</div>`);
                    return;
                }

                pdfSetStatus(`<div class="alert alert-success py-2">Файл загружен: <strong>${data.filename || file.name}</strong></div>`);
                pdfFormBlock.classList.remove('d-none');

                const uploadIdInput = document.getElementById('id_upload_id');
                if (uploadIdInput) uploadIdInput.value = data.upload_id || '';
            }

            bindDnD(pdfDropZone);
            pdfDropZone.addEventListener('drop', (e) => {
                const f = e.dataTransfer.files && e.dataTransfer.files[0]; // (f) файл из dnd
                handlePdfFile(f);
            });
            pdfDropZone.addEventListener('click', () => pdfInput.click());
            pdfInput.addEventListener('change', e => handlePdfFile(e.target.files[0]));

            // =========================================================
            // TAB: ZIP
            // =========================================================
            const zipUploadUrl = "{% url 'projects:project_upload_archive' %}"; // (zipUploadUrl) endpoint загрузки архива

            const zipDropZone = document.getElementById("zipDropZone"); // (zipDropZone) зона DnD ZIP
            const zipInput = document.getElementById("zipInput"); // (zipInput) input ZIP
            const zipBtnUpload = document.getElementById("zipBtnUpload"); // (zipBtnUpload) кнопка "Загрузить"
            const zipBtnReset = document.getElementById("zipBtnReset"); // (zipBtnReset) кнопка "Сбросить"
            const zipUploadStatus = document.getElementById("zipUploadStatus"); // (zipUploadStatus) блок статуса

            const zipProgressWrap = document.getElementById("zipProgressWrap"); // (zipProgressWrap) обёртка прогресса
            const zipProgressBar = document.getElementById("zipProgressBar"); // (zipProgressBar) полоса прогресса
            const zipProgressPct = document.getElementById("zipProgressPct"); // (zipProgressPct) текст процентов

            const zipResultSummary = document.getElementById("zipResultSummary"); // (zipResultSummary) итоговый блок
            const zipResultTableWrap = document.getElementById("zipResultTableWrap"); // (zipResultTableWrap) обёртка таблицы
            const zipResultTbody = document.getElementById("zipResultTbody"); // (zipResultTbody) тело таблицы

            let zipSelected = null; // (zipSelected) выбранный ZIP файл

            function zipSetStatus(html) { // (html) html статуса
                zipUploadStatus.innerHTML = html || "";
            }

            function zipSetButtons(enabled) { // (enabled) можно ли нажимать кнопки
                zipBtnUpload.disabled = !enabled;
                zipBtnReset.disabled = !enabled;
            }

            function setZipProgress(loaded, total) { // (loaded) загружено байт, (total) всего байт
                const pct = total ? Math.round((loaded / total) * 100) : 0; // (pct) проценты
                if (zipProgressBar) zipProgressBar.style.width = pct + "%";
                if (zipProgressPct) zipProgressPct.textContent = pct + "%";
            }

            function zipShowProgress(label) { // (label) текст слева над прогрессом
                if (zipProgressWrap) zipProgressWrap.classList.remove("d-none");
                const left = zipProgressWrap?.querySelector(".d-flex span"); // (left) левый текст
                if (left && label) left.textContent = label;
            }

            function zipHideProgress() {
                if (zipProgressWrap) zipProgressWrap.classList.add("d-none");
                setZipProgress(0, 0);
                if (zipProgressPct) zipProgressPct.textContent = "0%";
            }

            function zipReset() {
                zipSelected = null;
                zipInput.value = "";
                zipSetStatus("");
                zipSetButtons(false);

                if (zipProgressWrap) zipProgressWrap.classList.add("d-none");
                setZipProgress(0, 0);

                zipResultSummary.textContent = "Здесь появится отчёт после обработки архива.";
                zipResultTableWrap.classList.add("d-none");
                zipResultTbody.innerHTML = "";
            }

            function zipValidate(file) { // (file) File
                if (!file) return "Файл не выбран";
                const name = (file.name || "").toLowerCase(); // (name) имя файла
                const ok = name.endsWith(".zip") || file.type === "application/zip"; // (ok) признак zip
                if (!ok) return "Нужен ZIP архив (.zip)";
                return null;
            }

            function zipPick(file) {
                const err = zipValidate(file); // (err) текст ошибки или null
                if (err) {
                    zipSelected = null;
                    zipSetButtons(false);
                    zipSetStatus(`<div class="alert alert-danger py-2">${err}</div>`);
                    return;
                }
                zipSelected = file;
                zipSetButtons(true);
                zipSetStatus(`<div class="alert alert-info py-2">Выбран архив: <strong>${file.name}</strong></div>`);
            }

            function zipBadge(status) { // (status) статус файла от backend
                if (status === "created") return `<span class="badge bg-success">Добавлено</span>`;
                if (status === "duplicate") return `<span class="badge bg-secondary">Дубликат sha256</span>`;
                if (status === "error") return `<span class="badge bg-danger">Ошибка</span>`;
                return `<span class="badge bg-light text-dark">${status || "—"}</span>`;
            }

            function zipRender(results) { // (results) массив результатов
                let created = 0, duplicate = 0, error = 0; // (created/duplicate/error) счётчики

                zipResultTbody.innerHTML = "";
                (results || []).forEach(r => {
                    const st = r.status; // (st) статус элемента
                    if (st === "created") created++;
                    else if (st === "duplicate") duplicate++;
                    else if (st === "error") error++;

                    const tr = document.createElement("tr"); // (tr) строка таблицы
                    tr.innerHTML = `
        <td style="word-break:break-word;">${r.file || "—"}</td>
        <td style="word-break:break-word;">${r.project || "—"}</td>
        <td class="text-center">${r.revision || "—"}</td>
        <td class="text-center">${zipBadge(st)}</td>
      `;
                    zipResultTbody.appendChild(tr);
                });

                zipResultSummary.innerHTML = `
      <div class="alert alert-primary py-2 mb-0">
        Обработано: <strong>${(results || []).length}</strong> |
        Добавлено: <strong>${created}</strong> |
        Дубликаты sha256: <strong>${duplicate}</strong> |
        Ошибки: <strong>${error}</strong>
      </div>
    `;

                zipResultTableWrap.classList.toggle("d-none", !(results && results.length));
            }

            bindDnD(zipDropZone);
            zipDropZone.addEventListener("drop", (e) => {
                const f = e.dataTransfer.files && e.dataTransfer.files[0]; // (f) файл из dnd
                zipPick(f);
            });
            zipDropZone.addEventListener("click", () => zipInput.click());
            zipInput.addEventListener("change", (e) => zipPick(e.target.files[0]));
            zipBtnReset.addEventListener("click", zipReset);

            // ✅ ВАЖНО: для прогресса заменили fetch -> XMLHttpRequest
            zipBtnUpload.addEventListener("click", function (e) {
                e.preventDefault();

                const err = zipValidate(zipSelected); // (err) ошибка валидации
                if (err) {
                    zipSetStatus(`<div class="alert alert-danger py-2">${err}</div>`);
                    return;
                }

                // UI блокировка
                zipBtnUpload.disabled = true;
                zipBtnReset.disabled = true;

                // показываем прогресс
                if (zipProgressWrap) zipProgressWrap.classList.remove("d-none");
                setZipProgress(0, zipSelected.size);

                zipSetStatus(`<div class="alert alert-secondary py-2 mb-0">Загрузка архива…</div>`);

                const fd = new FormData(); // (fd) multipart-данные
                fd.append("archive", zipSelected); // ('archive') поле как ожидает backend

                const xhr = new XMLHttpRequest(); // (xhr) запрос с прогрессом upload
                xhr.open("POST", zipUploadUrl, true);
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
                xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

                xhr.upload.onprogress = function (evt) { // (evt) ProgressEvent
                    if (!evt.lengthComputable) return;

                    zipShowProgress("Загрузка архива…");
                    setZipProgress(evt.loaded, evt.total);

                    // Когда байты уже ушли — дальше НЕ загрузка, а ожидание/обработка на сервере
                    if (evt.loaded >= evt.total) {
                        zipShowProgress("Архив загружен. Идёт обработка…");
                        zipSetStatus(`<div class="alert alert-info py-2 mb-0">Архив загружен. Идёт обработка…</div>`);
                    }
                };

                xhr.onload = function () {
                    zipHideProgress();
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const parsed = safeJsonText(xhr.responseText); // (parsed) {ok, data|error}
                        if (!parsed.ok) {
                            zipSetStatus(`<div class="alert alert-danger py-2">${parsed.error}</div>`);
                            zipBtnUpload.disabled = false;
                            zipBtnReset.disabled = false;
                            return;
                        }

                        const data = parsed.data; // (data) JSON от backend
                        if (!data || data.ok !== true) {
                            zipSetStatus(`<div class="alert alert-danger py-2">Ошибка: ${(data && (data.error || data.message)) || "Ошибка обработки архива"}</div>`);
                            zipBtnUpload.disabled = false;
                            zipBtnReset.disabled = false;
                            return;
                        }

                        zipSetStatus(`<div class="alert alert-success py-2">Готово. Обработано файлов: <strong>${data.processed}</strong></div>`);
                        zipRender(data.results || []);
                        zipBtnUpload.disabled = false;
                        zipBtnReset.disabled = false;
                        return;
                    }

                    zipSetStatus(`<div class="alert alert-danger py-2">Ошибка загрузки архива (status ${xhr.status})</div>`);
                    zipBtnUpload.disabled = false;
                    zipBtnReset.disabled = false;
                };

                xhr.onerror = function () {
                    zipSetStatus(`<div class="alert alert-danger py-2">Ошибка сети</div>`);
                    zipBtnUpload.disabled = false;
                    zipBtnReset.disabled = false;
                };

                xhr.send(fd);
            });

            zipReset();
        })();
    </script>
{% endblock %}
