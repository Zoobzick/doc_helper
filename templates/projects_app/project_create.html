{% extends "base.html" %}

{% block content %}
<main id="main" class="main">
<div class="pagetitle">
  <h1>Добавить проект</h1>
</div>

<section class="section">
  <div class="row">
    <div class="col-12 col-lg-10">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">1) Загрузите PDF проекта</h5>

          <div
            id="dropZone"
            class="border border-2 border-secondary rounded-3 p-5 text-center"
            style="border-style:dashed; user-select:none; cursor:pointer;"
          >
            <div class="fw-semibold">Перетащите сюда PDF</div>
            <div class="text-muted small">или кликните, чтобы выбрать файл</div>
            <input id="fileInput" type="file" accept="application/pdf" class="d-none">
          </div>

          <div id="uploadStatus" class="mt-3"></div>

          <hr class="my-4">

          <div id="formBlock" class="{% if form.errors %}{% else %}d-none{% endif %}">
            <h5 class="card-title">2) Заполните данные</h5>

            <form method="post" action="{% url 'projects:project_create_save' %}" class="row g-3" id="projectForm">
              {% csrf_token %}
              {{ form.upload_id }}

              <div class="col-12">
                <label class="form-label">Полный шифр проекта</label>
                {{ form.full_code }}
                {% if form.full_code.errors %}<div class="text-danger small">{{ form.full_code.errors }}</div>{% endif %}
                <div class="form-text">
                  Если такой шифр уже есть, загруженный PDF будет добавлен как новая ревизия (02/03/...).
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Наименование / конструктив</label>
                {{ form.construction }}
                {% if form.construction.errors %}<div class="text-danger small">{{ form.construction.errors }}</div>{% endif %}
              </div>

              <div class="col-12">
                <div class="form-check">
                  {{ form.needs_review }}
                  <label class="form-check-label ms-1" for="id_needs_review">Требует заполнения</label>
                </div>
              </div>

              <div class="col-12">
                <button class="btn btn-success" type="submit">Сохранить</button>
              </div>
            </form>
          </div>

        </div>
      </div>

    </div>
  </div>
</section>
</main>

<script>
(function () {
  const uploadUrl = "{% url 'projects:project_upload_temp' %}";

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const uploadStatus = document.getElementById('uploadStatus');
  const formBlock = document.getElementById('formBlock');

  ['dragenter','dragover','dragleave','drop'].forEach(evt => {
    window.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
    document.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
  });

  function setStatus(html) { uploadStatus.innerHTML = html || ''; }

  function csrfToken() {
    const name = 'csrftoken=';
    const parts = document.cookie.split(';').map(s => s.trim());
    for (const p of parts) if (p.startsWith(name)) return decodeURIComponent(p.substring(name.length));
    return '';
  }

  function safeJson(resp) {
    const ct = (resp.headers.get("content-type") || "");
    if (!ct.includes("application/json")) {
      return resp.text().then(() => ({
        ok: false,
        error: `Сервер вернул не JSON (status ${resp.status}). Часто это 403/redirect.`
      }));
    }
    return resp.json().catch(() => ({
      ok:false,
      error:`Не удалось разобрать JSON (status ${resp.status}).`
    }));
  }

  function handleFile(file) {
    if (!file) return;

    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
      setStatus('<div class="alert alert-danger py-2">Разрешены только PDF</div>');
      return;
    }

    setStatus('<div class="text-muted">Загрузка…</div>');

    const fd = new FormData();
    fd.append('file', file);

    fetch(uploadUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken() },
      body: fd
    })
    .then(safeJson)
    .then(data => {
      if (!data || data.ok !== true) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : 'Ошибка загрузки';
        setStatus(`<div class="alert alert-danger py-2">${msg}</div>`);
        return;
      }

      if (data.duplicate) {
        setStatus(`<div class="alert alert-warning py-2">${data.message || 'Дубликат по sha256'}</div>`);
        formBlock.classList.add('d-none');
        return;
      }

      setStatus(`<div class="alert alert-success py-2">Файл загружен: <strong>${data.filename || file.name}</strong></div>`);
      formBlock.classList.remove('d-none');

      const uploadIdInput = document.getElementById('id_upload_id');
      if (uploadIdInput) uploadIdInput.value = data.upload_id || '';
    })
    .catch(err => {
      setStatus(`<div class="alert alert-danger py-2">Ошибка сети/сервера: ${String(err)}</div>`);
    });
  }

  dropZone.addEventListener('dragover', () => dropZone.classList.add('bg-light'));
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-light'));
  dropZone.addEventListener('drop', (e) => {
    dropZone.classList.remove('bg-light');
    handleFile(e.dataTransfer.files[0]);
  });

  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
})();
</script>
{% endblock %}
