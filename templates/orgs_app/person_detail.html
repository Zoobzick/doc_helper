{% extends "base.html" %}

{% block content %}

  <div class="pagetitle">
    <h1>Человек</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'authapp:home' %}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{% url 'orgs_app:person_list' %}">Люди</a></li>
        <li class="breadcrumb-item active">Детали</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">

      <div class="col-12 col-lg-6">
        <div class="card">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
              <div>
                <h5 class="card-title mb-0">{{ item.full_name }}</h5>
                <p class="text-muted mb-0">{{ item.short_name }}</p>
              </div>

              <div class="d-flex gap-2 flex-wrap">
                <a class="btn btn-outline-secondary" href="{% url 'orgs_app:person_list' %}">Назад</a>

                {% if perms.orgs_app.change_person %}
                  <a class="btn btn-primary" href="{% url 'orgs_app:person_update' item.uuid %}">
                    <i class="bi bi-pencil me-1"></i> Редактировать
                  </a>
                {% endif %}

                {% if perms.orgs_app.delete_person %}
                  <a class="btn btn-danger" href="{% url 'orgs_app:person_delete' item.uuid %}">
                    <i class="bi bi-trash me-1"></i> Удалить
                  </a>
                {% endif %}
              </div>
            </div>

            <dl class="row mb-0">
              <dt class="col-sm-4">Активен</dt>
              <dd class="col-sm-8">
                {% if item.is_active %}
                  <span class="badge bg-success">Да</span>
                {% else %}
                  <span class="badge bg-secondary">Нет</span>
                {% endif %}
              </dd>
            </dl>

          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <div>
                <h5 class="card-title mb-0">НРС (история)</h5>
                <p class="text-muted mb-0">Записи по человеку</p>
              </div>

              {% if perms.orgs_app.add_personnrs %}
                <a class="btn btn-sm btn-success" href="{% url 'orgs_app:personnrs_create' %}?person={{ item.uuid }}">
                  <i class="bi bi-plus-circle me-1"></i> Добавить НРС
                </a>
              {% endif %}
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered align-middle w-100">
                <thead>
                  <tr>
                    <th>НРС</th>
                    <th>С</th>
                    <th>По</th>
                    <th class="text-center">Активна</th>
                    <th class="text-center">Действия</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in item.nrs_records.all %}
                    <tr>
                      <td style="word-break: break-word;">{{ r.nrs_id }}</td>
                      <td>{{ r.valid_from|date:"d.m.Y" }}</td>
                      <td>{% if r.valid_to %}{{ r.valid_to|date:"d.m.Y" }}{% else %}<span class="text-muted">—</span>{% endif %}</td>

                      <td class="text-center">
                        {% if r.is_active %}
                          <span class="badge bg-success">Да</span>
                        {% else %}
                          <span class="badge bg-secondary">Нет</span>
                        {% endif %}
                      </td>

                      <td class="text-center text-nowrap">
                        {% if perms.orgs_app.view_personnrs %}
                          <a href="{% url 'orgs_app:personnrs_detail' r.uuid %}"
                             class="btn btn-sm btn-outline-primary"
                             title="Открыть">
                            <i class="bi bi-box-arrow-up-right"></i>
                          </a>
                        {% endif %}
                        {% if perms.orgs_app.change_personnrs %}
                          <a href="{% url 'orgs_app:personnrs_update' r.uuid %}"
                             class="btn btn-sm btn-outline-success ms-1"
                             title="Редактировать">
                            <i class="bi bi-pencil"></i>
                          </a>
                        {% endif %}
                        {% if perms.orgs_app.delete_personnrs %}
                          <a href="{% url 'orgs_app:personnrs_delete' r.uuid %}"
                             class="btn btn-sm btn-outline-danger ms-1"
                             title="Удалить">
                            <i class="bi bi-trash"></i>
                          </a>
                        {% endif %}
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="5" class="text-muted">Записей нет</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

    </div>
  </section>

{% endblock %}
