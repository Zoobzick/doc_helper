{% extends "base.html" %}
{% load static %}
{% block content %}

    <div class="pagetitle">
        <h1>{% if object %}Редактировать приказ{% else %}Добавить приказ{% endif %}</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'directive_app:directive_list' %}">Приказы</a></li>
                <li class="breadcrumb-item active">{% if object %}Редактирование{% else %}Добавление{% endif %}</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="card">
            <div class="card-body">

                <div class="row pt-3">
                    <!-- Левая колонка -->
                    <div class="col-12 col-lg-6">
                        <div class="card">
                            <div class="card-body">

                                <h5 class="card-title">Загрузите файл приказа (PDF)</h5>

                                <!-- DnD зона как в passport_upload -->
                                <div id="directiveDropZone"
                                     class="border border-2 border-secondary rounded-3 p-5 text-center"
                                     style="border-style:dashed; user-select:none; cursor:pointer;">
                                    <div class="fw-semibold">Перетащите сюда PDF</div>
                                    <div class="text-muted small">или кликните, чтобы выбрать</div>
                                </div>

                                <div id="uploadStatus" class="mt-3"></div>

                                {% if form.pdf_file.errors %}
                                    <div class="text-danger small mt-2">{{ form.pdf_file.errors }}</div>
                                {% endif %}

                                <div class="form-text mt-2">
                                    Поддерживается формат: <code>pdf</code>.
                                </div>

                                {% if object and object.pdf_file %}
                                    <div class="small mt-2">
                                        Текущий файл:
                                        <a href="{% url 'directive_app:directive_open' uuid=object.uuid %}"
                                           target="_blank">открыть</a>
                                        <span class="text-muted mx-2">|</span>
                                        <a href="{% url 'directive_app:directive_download' uuid=object.uuid %}">скачать</a>
                                    </div>
                                {% endif %}

                                <hr class="my-4">

                                <form method="post" enctype="multipart/form-data" id="directiveForm">
                                    {% csrf_token %}

                                    <!-- скрытый input файла -->
                                    <div class="d-none">
                                        {{ form.pdf_file }}
                                    </div>

                                    <h5 class="card-title mb-3">Данные приказа</h5>

                                    <div class="row g-2">

                                        <!-- Тип -->
                                        <div class="col-12">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label mb-0">Тип</label>
                                                </div>
                                                <div class="col-12 col-md-9">
                                                    {{ form.doc_type }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Номер -->
                                        <div class="col-12">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label mb-0">Номер</label>
                                                </div>
                                                <div class="col-12 col-md-9">
                                                    {{ form.number }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Дата -->
                                        <div class="col-12">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label mb-0">Дата</label>
                                                </div>
                                                <div class="col-12 col-md-9">
                                                    {{ form.date }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Кем выдан -->
                                        <div class="col-12">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label mb-0">Кем выдан</label>
                                                </div>
                                                <div class="col-12 col-md-9">
                                                    {{ form.issuer_organization }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Примечание -->
                                        <div class="col-12">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label mb-0">Примечание</label>
                                                </div>
                                                <div class="col-12 col-md-9">
                                                    {{ form.note }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Активен -->
                                        <div class="col-12">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label mb-0">Статус</label>
                                                </div>
                                                <div class="col-12 col-md-9">
                                                    <div class="form-check">
                                                        {{ form.is_active }}
                                                        <label class="form-check-label">Активен</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>


                                    <div class="mt-3 d-flex gap-2 flex-wrap">
                                        <button class="btn btn-success" type="submit" id="btnSave">
                                            <i class="bi bi-check2-circle me-1"></i> Сохранить
                                        </button>

                                        <a class="btn btn-outline-secondary"
                                           href="

                                                   {% if object %}{% url 'directive_app:directive_detail' uuid=object.uuid %}{% else %}{% url 'directive_app:directive_list' %}{% endif %}">
                                            Назад
                                        </a>

                                        <button class="btn btn-outline-secondary" type="button" id="btnReset">
                                            Сбросить
                                        </button>
                                    </div>

                                    <div class="mt-2 text-muted small" id="pickedInfo"></div>
                                </form>

                            </div>
                        </div>
                    </div>

                    <!-- Правая колонка -->
                    <div class="col-12 col-lg-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Предпросмотр</h5>

                                <div id="previewEmpty" class="text-muted">
                                    Выберите файл — здесь появится предпросмотр (PDF).
                                </div>

                                <div id="previewNonPdf" class="d-none">
                                    <div class="alert alert-info py-2 mb-0">
                                        Предпросмотр доступен только для PDF.
                                    </div>
                                </div>

                                <iframe id="pdfPreviewFrame"
                                        style="display:none; width:100%; height:70vh; border:1px solid #e5e5e5; border-radius:8px;"></iframe>

                                {% if object and object.pdf_file %}
                                    <div class="mt-2 small text-muted">
                                        Предпросмотр текущего файла:
                                        <a href="{% url 'directive_app:directive_open' uuid=object.uuid %}"
                                           target="_blank">открыть</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </section>

{% endblock %}

{% block extra_js %}
    <script>
        (function () {
            function bindDnD(dropEl) {
                ["dragenter", "dragover", "dragleave", "drop"].forEach((evt) => {
                    dropEl.addEventListener(evt, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });
                dropEl.addEventListener("dragover", () => dropEl.classList.add("bg-light"));
                dropEl.addEventListener("dragleave", () => dropEl.classList.remove("bg-light"));
                dropEl.addEventListener("drop", () => dropEl.classList.remove("bg-light"));
            }

            function isPdf(file) {
                const name = file && file.name ? file.name.toLowerCase() : "";
                return (file && file.type === "application/pdf") || name.endsWith(".pdf");
            }

            const dropZone = document.getElementById("directiveDropZone");
            const form = document.getElementById("directiveForm");
            const fileInput = form.querySelector('input[name="pdf_file"]');

            const uploadStatus = document.getElementById("uploadStatus");
            const pickedInfo = document.getElementById("pickedInfo");

            const frame = document.getElementById("pdfPreviewFrame");
            const empty = document.getElementById("previewEmpty");
            const nonPdfBox = document.getElementById("previewNonPdf");

            const btnReset = document.getElementById("btnReset");

            let currentObjectUrl = null;

            function clearPreview() {
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
                frame.style.display = "none";
                frame.src = "";
                nonPdfBox.classList.add("d-none");
                empty.style.display = "block";
            }

            function showPdfPreview(file) {
                clearPreview();
                if (!file) return;

                if (isPdf(file)) {
                    currentObjectUrl = URL.createObjectURL(file);
                    frame.src = currentObjectUrl + "#page=1";
                    empty.style.display = "none";
                    frame.style.display = "block";
                } else {
                    empty.style.display = "none";
                    nonPdfBox.classList.remove("d-none");
                }
            }

            function setStatus(html) {
                uploadStatus.innerHTML = html || "";
            }

            function handlePickedFile(file) {
                if (!file) return;

                const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
                pickedInfo.innerHTML = `Выбран файл: <strong>${file.name}</strong> (${sizeMb} MB)`;

                if (!isPdf(file)) {
                    setStatus('<div class="alert alert-danger py-2">Нужен PDF файл (.pdf)</div>');
                    clearPreview();
                    return;
                }

                setStatus("");
                showPdfPreview(file);
            }

            function pickFileFromDnd(file) {
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                handlePickedFile(file);
            }

            bindDnD(dropZone);
            dropZone.addEventListener("click", () => fileInput.click());
            dropZone.addEventListener("drop", (e) => {
                const f = e.dataTransfer.files && e.dataTransfer.files[0];
                if (f) pickFileFromDnd(f);
            });

            fileInput.addEventListener("change", (e) => {
                const f = e.target.files && e.target.files[0];
                handlePickedFile(f);
            });

            btnReset.addEventListener("click", () => {
                clearPreview();
                fileInput.value = "";
                pickedInfo.innerHTML = "";
                setStatus("");
            });
        })();
    </script>
{% endblock %}
